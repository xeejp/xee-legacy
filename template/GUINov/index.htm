<!DOCTYPE html>
<!-- saved from url=(0029)http://localhost/new/XEE.html -->
<html lang="ja"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> 
	<meta charset="utf-8">
	<title>XEE</title>
	<style>
		#toolbox {
			min-width: 640px;
			min-height: 240px;
			margin: 0px;
			padding: 0px;
			background-color: #CCCCCC;
			border: 1px solid #000000;
			position: relative;
		}

		#dropbox {
			min-width: 640px;
			min-height: 480px;
			margin: 0px;
			padding: 0px;
			background-color: #FFFFFF;
			border: 1px solid #000000;
			position: relative;
		}

		#databox {
			min-width: 640px;
			min-height: 240px;
			margin: 0px;
			padding: 0px;
			background-color: #CCCCCC;
			border: 1px solid #000000;
			position: relative;
		}

		.tool {
			min-width: 49px;
			min-height: 49px;
			border: 1px solid #000000;
			border-radius: 5px;
			margin: 0px;
			padding: 0px;
			text-align: center;
			float: left;
			position: relative;
			background-color: rgba(0,128,128,0.5);
			cursor: move;
		}

		.value {
			min-width: 49px;
			min-height: 24px;
			border: 1px solid #000000;
			border-radius: 5px;
			margin: 0px;
			padding: 0px;
			text-align: center;
			float: left;
			position: relative;
			background-color: rgba(1280,0,128,0.5);
			cursor: move;
		}
		.gridbg {
			background-image:
				linear-gradient(transparent 90%, rgba(0,128,255,0.1) 50%),
				linear-gradient(90deg, transparent 90%, rgba(0,128,255,0.1) 50%);
			background-size: 10px 10px;
			background-repeat: repeat;
			background-position: 1px 1px;
		}

/*---選択されたときのcss、テキスト選択の禁止---*/
		.selected {
			border-width: 3px;
		}

		#toolbox #dropbox{
			-webkit-user-select: none;
			user-select: none;
		}

		li {
			list-style-type: none;
			float:left;
			width:100%;
		}

         span.demo1 {
            background-color:yellow;
            margin-right:20px;
            padding:5px;
         }

	</style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
	<script src="contextmenu.js" type="text/javascript"></script>
	<script type="text/javascript">
		window.onload = function(){
			var tools = [];
			tools[tools.length] = { 'functionName': 'if', 'class': 'tool' };
			tools[tools.length] = { 'functionName': 'else', 'class': 'tool' };
			tools[tools.length] = { 'functionName': 'switch', 'class': 'tool' };
			tools[tools.length] = { 'functionName': 'case', 'class': 'tool' };
			tools[tools.length] = { 'functionName': '$users', 'class': 'value' };
			tools[tools.length] = { 'functionName': '$users[$i]', 'class': 'value' };
			tools[tools.length] = { 'functionName': '$wtp', 'class': 'value' };
			tools[tools.length] = { 'functionName': '$cost', 'class': 'value' };
			tools[tools.length] = { 'functionName': '$price', 'class': 'value' };
			tools[tools.length] = { 'functionName': 'loop', 'class':'tool'};
			tools[tools.length] = { 'functionName': 'make', 'class': 'tool' };

/*---toolboxをクラスごとに振り分けするための変数---*/
			var div_mem = [];
			//$('#toolbox').append($('<ul>').attr('id','tab'));
			//$('.tab').append('<ul>');
/*-------------------------------------------------*/

			for (var i = 0; i < tools.length; i++) {
/*---toolをクラス別に振り分け---*/
				if($.inArray(tools[i]['class'],div_mem) < 0){
					div_mem.push(tools[i]['class']);
					$('#toolbox').append($('<li>').append(tools[i]['class']));
					var  box= $('<li>').attr('id','toolbox_' +tools[i]['class']);
					$('#toolbox').append(box);
				};

/*------------------------------*/

//---f_createtool(tools[i]['name'],'toolbox', tools[i]['functionName'], tools[i]['class']);
				f_createtool(tools[i]['functionName'],'toolbox_' + tools[i]['class'], tools[i]['functionName'], tools[i]['class']);
			};

/*---doropboxの右クリックメニュー,toolboxのinput入力不可---*/
//dropbox右クリック追加の仕方
//1:<body>内のdropBoxMenuに<li>を追加する
//2:'dropboxMenuメニュー<li>のid' : function(t) {idの実行したい処理},　を下記のbindings内に追加

			$('#dropbox').contextMenu('dropBoxMenu',{bindings: {
				'peast': function(t) {peast(copy_data,event.pageX,event.pageY);},
				'undo': function(t) {undo();},
				'redo': function(t) {redo();},
			}})
			.click(function(){f_click(event)});
		
	//		$('#tab').tabs();
			$('#toolbox input').prop('disabled',true)
		};
/*----------------------------------*/

		var toolnum = 0;
		function f_setValue(toolid, value) {
			var parentId = 	document.getElementById(toolid).parentNode.id;
			var elm = document.getElementById(parentId);
			var obj = document.createElement("input");
			var index0 = elm.innerHTML.indexOf(">") + 1;
			var preHTML = elm.innerHTML.substring(index0, elm.innerHTML.length);
			document.getElementById(parentId).removeChild(document.getElementById(toolid));

			obj.setAttribute('id', 'input_' + parentId + '_' + toolnum);
			obj.setAttribute('onchange', 'f_setValue(\'input_' + parentId + '_' + toolnum + '\', this.value)');
			obj.setAttribute('draggable', 'false');
			obj.setAttribute('value', value);
			obj.setAttribute('type', 'text');
			obj.setAttribute('size', 1);

			switch(elm.getAttribute('functionName')){
				case 'loop':

					elm.innerHTML = 'Loop';
					elm.appendChild(obj);
					elm.innerHTML += preHTML;
					break;
				case 'make':
					elm.innerHTML = 'Make';
					elm.appendChild(obj);
					elm.innerHTML += preHTML;
					break;
				default:
					elm.innerHTML = '';
					break;
			}

			Jsonset();
/*---inputが変更された時もundoの対象にする---*/
			undo_set();
/*-------------------------------------------*/
			toolnum++;
			return obj.getAttribute('id');
		}
		// ドロップ元1階層上
		var pre_drop;
		// ドロップ元一番上
		var pre_drop_parent;
		// ドロップ先1階層上
		var pst_drop;
		// ドロップ先一番上
		var pst_drop_parent;

/*---変数の追加---*/
		//コピーデータ
		var copy_data;
		//アンドゥ用保存
		var undo_data =[''];
		//リドゥ用保存
		var redo_data = [];
/*------------------*/

		var drag_elm_X;
		var drag_elm_Y;
		// ドラッグ開始時
		function f_dragstart(evt){
			evt.dataTransfer.setData("text", evt.target.id);
			var scrollX = document.documentElement.scrollLeft || document.body.scrollLeft ;
			var scrollY = document.documentElement.scrollTop || document.body.scrollTop ;
			var mouseX = scrollX + evt.clientX;
			var mouseY = scrollY + evt.clientY;
			drag_elm_X = mouseX - evt.target.getBoundingClientRect().left;
			drag_elm_Y = mouseY - evt.target.getBoundingClientRect().top;
		}

		// dropboxと重なっている時
		function f_dragover(evt){
			evt.preventDefault();
		};

		// ドロップ時
		function f_drop(evt){
			var id_name = evt.dataTransfer.getData("text");
			var drag_elm = document.getElementById(id_name);

			// dropした瞬間のマウスの座標を取得
			var scrollX = document.documentElement.scrollLeft || document.body.scrollLeft ;
			var scrollY = document.documentElement.scrollTop || document.body.scrollTop ;
			var mouseX = scrollX + evt.clientX;
			var mouseY = scrollY + evt.clientY;

			pre_drop = document.getElementById(id_name).parentNode.id;
			pre_drop_parent = id_name.slice(0, 7);
			pst_drop = evt.target.id;
			pst_drop_parent = evt.currentTarget.id;
console.log($(evt.target).width());

/*---例外となる位置にドロップした場合---*/
		//ドロップ先
			var new_evt =$(event.target);
		//input要素にドロップした場合
			if(pst_drop.slice(0,5) == 'input') {new_evt =$(evt.target).parent();pst_drop = new_evt.attr('id');};
		//自身、もしくは自身の子要素にドロップした場合
			if(parentcheck(id_name,evt.target)){pst_drop = pre_drop;new_evt = $(id_name).parent();};
/*-------------------------------*/

			if(pst_drop_parent == pst_drop_parent.slice(0, 7)){
				if(pre_drop_parent == 'toolbox' && pst_drop_parent == 'toolbox'){
					// toolboxからtoolboxへ移動した時
/*---不要？---*/
					//evt.currentTarget.appendChild(drag_elm);
						return;
/*--------*/

				}else if(pre_drop_parent == 'dropbox' && pst_drop_parent == 'dropbox'){
					// dropboxからdropboxへ移動した時
/*---idの書き換え---*/
					id_reset(drag_elm,pst_drop,false);
/*------------------*/
					if(pst_drop != 'dropbox'){
						// dropbox子孫要素へのドロップ
//---evt.target.appendChild(drag_elm);
						new_evt.append(drag_elm);
						drag_elm.setAttribute('style', 'position: relative; left: 5px; top: 5px; margin: 4px; float: right;');
					}else{
						// dropbox本体へのドロップ
						var new_tool_left = Math.floor(((mouseX - drag_elm_X) - document.getElementById('dropbox').getBoundingClientRect().left)/10)*10;
						var new_tool_top = Math.floor(((mouseY - drag_elm_Y) - document.getElementById('dropbox').getBoundingClientRect().top)/10)*10;

//---evt.target.appendChild(drag_elm);
						new_evt.append(drag_elm);
						var new_tool = document.getElementById(drag_elm.id);

						new_tool.setAttribute('style', 'position: absolute; left: ' + new_tool_left + 'px; top: ' + new_tool_top + 'px; float: right;');
					}

/*---redoのセット---*/
					redo_data = [];
/*------------------*/

				}else if(pre_drop_parent == 'toolbox' && pst_drop_parent == 'dropbox'){
					// toolboxからdropboxへ移動した時
					if(pst_drop != 'dropbox'){
						// toolboxからdropbox子孫要素へのドロップ
						var new_toolid = f_createtool(drag_elm.innerHTML, pst_drop, drag_elm.getAttribute('functionName'), drag_elm.getAttribute('class'));
						var new_tool = document.getElementById(new_toolid);

						new_tool.setAttribute('style', 'position: relative; left: 5px; top: 5px; margin: 4px; float: right;');
					}else{
						var new_tool_left = Math.floor(((mouseX - drag_elm_X) - document.getElementById('dropbox').getBoundingClientRect().left)/10)*10;
						var new_tool_top = Math.floor(((mouseY - drag_elm_Y) - document.getElementById('dropbox').getBoundingClientRect().top)/10)*10;

						var new_toolid = f_createtool(drag_elm.innerHTML, pst_drop, drag_elm.getAttribute('functionName'), drag_elm.getAttribute('class'));
						var new_tool = document.getElementById(new_toolid);

						new_tool.setAttribute('style', 'position: absolute; left: ' + new_tool_left + 'px; top: ' + new_tool_top + 'px; float: right;');
					}
/*---イベント追加とredoのセット---*/
					addEvent(new_tool);
					$(new_tool).addClass('item');
					redo_data = [];
/*------------------------------------------*/
				}else if(pre_drop_parent == 'dropbox' && pst_drop_parent == 'toolbox'){
					// dropboxからtoolboxへ移動した時
					drag_elm.parentNode.removeChild(drag_elm);

				}

				evt.preventDefault();
/*
				// DetaBoxへ書き出す
				var data = document.getElementById('dropbox');
				var parentLeft = data.getBoundingClientRect().left;
				var parentTop = data.getBoundingClientRect().top;
				var json_stringify_allow = ["id", "innerHTML"];

				}
*/

/*---undoにデータセット---*/
				undo_set();
/*------------------------*/
			}
		}

/*---クリック時選択状態にする(選択対象となる要素)---*/
		function f_click(evt){
			var select = document.getElementById(evt.target.id);
			$('.selected').removeClass('selected');
			if($(select).hasClass('item')){
				$(select).addClass('selected');
			}
		}
/*------------------------------*/

		function f_createtool(elmName, parentId, functionName, className){
			var obj = document.createElement('div');
			var elm = document.getElementById(parentId);
			switch(functionName){
				case 'loop':
					obj.innerHTML = 'Loop<input name="count" id="input_' + parentId + '_' + toolnum + '" size="1" onchange="f_setValue(\'input_' + parentId + '_' + toolnum + '\', this.value)" value="">times';
					obj.setAttribute('functionName', 'loop');
					break;
				case 'make':
					obj.innerHTML = 'Make<input name="count" id="input_' + parentId + '_' + toolnum + '" size="1" onchange="f_setValue(\'input_' + parentId + '_' + toolnum + '\', this.value)" value="">groups';
					obj.setAttribute('functionName', 'make');
					break;
				default:
					obj.innerHTML = elmName;
					obj.setAttribute('functionName', functionName);
					break;
			}
			obj.setAttribute('className', className);
			obj.setAttribute('class', className);
			obj.setAttribute('id', parentId + '_' + toolnum);
			obj.setAttribute('draggable', 'true');
			obj.setAttribute('ondragstart', 'f_dragstart(event)');
			obj.setAttribute('ondragover', 'f_dragover(event)');
			obj.setAttribute('ondrop', 'f_drop(event)');

/*---jQueryに書き換え---*/
			if(parentId != 'dropbox') $(obj).children('input');
			$(elm).append(obj);
			//elm.appendChild(obj);
/*----------------------*/
			toolnum++;
			return obj.getAttribute('id');
		}


/*---新たに追加した関数---*/
		//toolにイベントを追加(イベントを追加したい要素)
		function addEvent(box){
			$(box).contextMenu('toolMenu',{bindings: {
                		'copy': function(t) {if(confirm('cut?')){copy(box);}},
				'delete': function(t){box.remove();},
			}});
			$(box).attr('onclick', 'f_click(event)');
			if($(box).children('div').attr('id')){addEvent($(box).children('div'))}
		}

		//データコピー(コピーの対象となる要素)
		function copy(evt){
			if(evt.length  != 0){
				copy_data = $(evt).clone();
				$(copy_data).removeClass('selected');
			}
		}

		//データペースト(貼り付けたい要素,貼り付け位置のx,y)
		function peast(p_data,eX,eY){
			if(!confirm('peast?')) return;
			if(p_data != null){
				p_data = p_data.clone();
				id_reset(p_data,'dropbox',true);
				addEvent(p_data);
				var new_tool_left = eX - $('#dropbox').offset().left;
				var new_tool_top =  eY - $('#dropbox').offset().top;
				$(p_data).css({top: new_tool_top +'px' , left: new_tool_left + 'px',position : 'absolute'});
				$('#dropbox').append(p_data);
				undo_set();
			}else{alert('No data');}
		}

		//id書き換え(書き換えの対象となる要素,第１引数の新たな親要素のId,boolean 番号の振り直しの有無)
		function id_reset(des,parentId,newId){
			if(newId){
				var selfNum = toolnum;
			}else{
				var numSplit = $(des).attr('id').split('_');
				var selfNum = numSplit[numSplit.length - 1];
			}
			$(des).attr('id',parentId + '_' + selfNum);
			var selfId = $(des).attr('id');
			if($(des).children('input').attr('id') != null){
				$(des).children('input').attr('id','input_' + selfId );
				$(des).children('input').attr('onchange',"f_setValue('input_" + selfId + "', this.value)");
			}
			if(newId) toolnum++;
			if($(des).children('div').attr('id') != null){
				des = $(des).children('div');
				var Id = selfId;
				for(var i=0;i<des.length;i++){
					var childId = $(des[i]).attr('id');
					id_reset(des[i],Id,newId);
				}
			}
		}

		//自身にドロップしてないかチェック(ドロップした要素のid,ドロップ先の要素)
		function parentcheck(myId,drp){
			var drpId = $(drp).attr('id');
			if(myId == drpId){return true;}
			if($(drp).parent().attr('id') != undefined){
				if(parentcheck(myId,$(drp).parent())) return true;
			}
			return false;
		}

		//アンドゥ
		function undo_set(){
			if(undo_data[0] != document.getElementById('dropbox').innerHTML){
				undo_data.unshift(document.getElementById('dropbox').innerHTML);
				undo_data[4] = null;
			}
		}
		function undo(){
			if(undo_data[1] != null){
				redo_data.unshift(undo_data[0]);
				$('#dropbox').empty();
				$('#dropbox').append(undo_data[1]);
				addEvent($('#dropbox').children('div'));
				undo_data.shift();
				$('.selected').removeClass('selected');
			}
		}

		//リドゥ
		function redo(){
			if(redo_data[0] != null){
				$('#dropbox').empty();
				$('#dropbox').append(redo_data[0]);
				addEvent($('#dropbox').children('div'));
				redo_data.shift();
				undo_set();
				$('.selected').removeClass('selected');
			}
		}

		//inputまたはtextareaがfocus時キーイベントの禁止
		$(document).on('focus','input,textarea',function(){input_focus = true;})
			.on('blur','input,textarea',function(){input_focus = false;});

		//キーボード操作
		var input_focus = false;
		document.onkeydown = function(e) {
			if (!input_focus){
			//ctrlキーと同時押し
				if(event.ctrlKey){
					
					keychar = String.fromCharCode(event.keyCode).toUpperCase();
					switch(keychar){
						case 'C': if(confirm('copy?')){
								copy($('.selected'));
							}
							break;
						case 'V': peast(copy_data,$('#dropbox').offset().left,$('#dropbox').offset().top);
							break;
						case 'X': if(confirm('cut?')){
								copy($('.selected'));
								$('.selected').remove();
							}
							break;
						case 'Y': redo();
							break;
						case 'Z': undo();
							break;
					}
					return false;
				}
			//deleteキーが押されたとき
				if(event.keyCode == 46){
					$('.selected').remove();
					undo_set();
				}
			}
		}

		//JSONに変換
		function json_convert(prtId){
			var sameHierarchy = new Array();
			var box = $(prtId).children('div');

		//兄弟要素をすべて変換
			for(var i=0;i<box.length;i++){
				var convertData = new Object();
				convertData['functionname'] = $(box[i]).attr('functionname');
				//convertData['id'] = $(box[i]).attr('id');
				convertData['className'] = $(box[i]).attr('className');
				convertData['left'] = Math.ceil($(box[i]).position().left);
				convertData['top'] = Math.ceil($(box[i]).position().top);
			//inputboxを持っている場合の中身取得
				if($(box[i]).children('input').attr('id') != null){
					var inputData = new Object;
					inputData['name'] = $(box[i]).children('input').attr('name');
					//inputData['id'] = $(box[i]).children('input').attr('id');
					inputData['value'] = $(box[i]).children('input').attr('value');
					convertData['input'] = inputData;
				}else{
					convertData['input'] = null;
				}
			//子要素がある場合
				if($(box[i]).children('div').attr('id') != null){
					convertData['nest'] = json_convert($(box[i]));
				}else{
					convertData['nest'] = null;
				}
				sameHierarchy.push(convertData);
			}
			//dropboxの左から順に整列(leftが等しい場合はtopが小さい順)
			sameHierarchy.sort(function(a,b){
						if(a.left < b.left) return -1;
						if(a.left > b.left) return 1;
						if(a.top < b.top) return -1;
						if(a.top > b.top) return 1;
						return 0;
			});
			return sameHierarchy;
		}
		
		//JSONを出力
		function JsonExport(){
				$('#databox').val('');
				if($('#dropbox').text() != ''){
					$('#databox').val(JSON.stringify(json_convert('#dropbox')));
				}
		}

		//JSONを入力
		function JsonImport() {
			var getValue = $('#databox')[0].value;
			try {
				var obj = $.parseJSON(getValue);
			} catch (e) {
				alert('不正なオブジェクト文字列が入力されましたStackTrace:' + e);
				return false;
			}
			$('#dropbox').empty();
			for (i in obj) {
				var boxId = '#' + f_createtool(obj[i].functionname, "dropbox", obj[i].functionname, obj[i].className);
				$(document).ready(function () {
					if($(boxId).children('input').attr('id') != null)$(boxId).children('input').attr('value',obj[i].input.value);
					$(boxId).addClass('item');
					$(boxId).css('position', 'absolute');
					$(boxId).css('top', obj[i].top);
					$(boxId).css('left', obj[i].left);
					$(boxId).css('float', 'right');
					if(obj[i].nest != null){nestOpen(obj[i].nest,$(boxId).attr('id'));};
					addEvent(boxId);
				});
			}
			redo_data.length = 0;
			undo_data.length = 0;
			undo_set();
			return true;
		}

		function nestOpen(nestdata,prtId){
			for (i in nestdata){
				var boxId = '#' + f_createtool(nestdata[i].functionname,prtId, nestdata[i].functionname, nestdata[i].className);
				if($(boxId).children('input').attr('id') != null)$(boxId).children('input').attr('value',nestdata[i].input.value);
				$(boxId).addClass('item');
				$(boxId).css('position', 'relative');
				$(boxId).css('top','5px');
				$(boxId).css('left','5px');
				$(boxId).css('margin','4px');
				$(boxId).css('float', 'right');
				if(nestdata[i].nest != null){nestOpen(nestdata[i].nest,$(boxId).attr('id'));};
			}
		}

/*---------------------------------------------*/
	</script>
</head>
	<body>

		<div>ToolBox</div>
		<div id="toolbox" ondragover="f_dragover(event)" ondrop="f_drop(event)"></div>
		<div>DropBox</div>
		<div id="dropbox" class="gridbg" ondragover="f_dragover(event)" ondrop="f_drop(event)"></div>
		<div>DataBox</div>
<!--新たに追加した部分-->
	<div class="contextMenu" id="toolMenu"><ul>
		<li id="copy">Copy</li>
		<li id="delete">Delete</li>
	</ul></div>
	<div class="contextMenu" id="dropBoxMenu"><ul>
		<li id="peast">Peast</li>
		<li id="undo">Undo</li>
		<li id="redo">Redo</li>
	</ul></div>
			<textarea id='databox'></textarea>
<input type="button" onClick="JsonExport()" value ="convert">
<input type="button" onClick="JsonImport()" value ="import">
<!---------------------------------------------->
</body>
</html>